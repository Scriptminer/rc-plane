<!DOCTYPE html>
<html>
<head>
<title>FLIGHT STATUS</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style>

html {
		background-color: #ccc;
        background: url('FighterBackground.png') no-repeat center center fixed;
        -webkit-background-size: cover;
        -moz-background-size: cover;
        -o-background-size: cover;
        background-size: cover;
}

table, td {
	border: 0.2vw solid purple;
	border-collapse: collapse
}

td {
	position: relative;
	width: 25%;
	height: 25%;
}

tr {
	height: 25%;
	width: 100%;
}

tbody {
	position:relative;
}

#displayGrid {
	position: absolute;
	width: 94%;
	height: 80%;
	left: 3%;
	bottom: 3%;

	background-color: rgba(220,220,220,0.5);
}

#topHeading {
	font-size: 130%;
}

#logTitle {
	color: #52a;
	font-size: 3vh;
	align: center;
}

.controlBox {
	position: absolute;
	/*width: 96%;
	height: 95%;
	left: 2%;
	top: 2%;*/

	width: 100%;
	height: 100%;
	left: 0%;
	top: 0%;

	background-color: rgba(130,130,130,0.3);
	font-size: 2vh;
}

.controlTitle {
	color: #03a;
	font-size: 3vh;
}

.subnote {
	color: #446;
	font-size: 60%;
}

</style>
<script src="jquery.min.js"></script>
<script src="http://cdn.jsdelivr.net/sockjs/0.3/sockjs.min.js"></script> <!-- Will have to be a served file - not website in final version -->
<script>

$(function() {
    var conn = null;

    function log(msg) {
      var control = $('#log');
      control.html(control.html() + msg + '<br/>');
      control.scrollTop(control.scrollTop() + 1000);
    }

    function connect() {
      disconnect();

      var transports = ["websocket", "xhr-streaming", "iframe-eventsource", "iframe-htmlfile", "xhr-polling", "iframe-xhr-polling", "jsonp-polling"];

      conn = new SockJS('http://' + window.location.host + '/chat', transports);

      log('Connecting...');

      conn.onopen = function() {
        // Called when we manage to connect to the server.
        log('Connected.');
        update_ui();
      };

      conn.onmessage = function(e) {
        // Called when we receive a message from the server.
        try {
          o = JSON.parse(e.data)
        } catch (exn) {
          log('Received corrupt data packet (' + exn + '): ' + e.data)
          return;
        }

        if (!o.type) {
          log('Received packet with no type: ' + e.data)
          return;
        }

      };

      conn.onclose = function() {
        // Called when we are disconnected from the server.
        log('Disconnected.');
        conn = null;
        update_ui();
      };
    }

    function disconnect() {
      // Called to request disconnection from the server.
      if (conn != null) {
        log('Disconnecting...');

        conn.close();
        conn = null;

        update_ui();
      }
    }

    function update_ui() {
      // Updates the status and changes the button to "connect" when disconnected, and vice versa
      var msg = '';

      if (conn == null || conn.readyState != SockJS.OPEN) {
        $('#status').text('disconnected');
        $('#connect').text('Connect');
      } else {
        $('#status').text('connected (' + conn.protocol + ')');
        $('#connect').text('Disconnect');
      }
    }

    function sendJson(msg) {
      // Send JSON object to server.
      sendRaw(JSON.stringify(msg))
    }

    function sendRaw(msg) {
      // Send raw message to server.
      conn.send(msg)
    }

    $('#connect').click(function() {
      if (conn == null) { // If not connected
        connect();
      } else {
        disconnect();
      }

      update_ui();
      return false;
    });

    $('#quit').click(function() {
      sendJson({'type': 'cmd', 'cmd': 'quit'});
      return false;
    });

    connect();
});

//////////////////// DISPLAY ////////////////////

var controls = [{name:"Ailerons",symbol:"°",mes:"Roll"},
                {name:"Elevator",symbol:"°",mes:"Pitch"},
                {name:"Rudder",symbol:"°",mes:"Yaw"},
                {name:"Throttle",symbol:"%",mes:"Speed"}]; // Throttle is special case - variable will be entered seperately

function setupDisplay(){
	var positions = [	["","","",""], // First ROW
					    ["","","",""], // Second ROW
					    ["","","",""], // Third ROW
					    ["","",""], // Fourth ROW
					];

	for(var i=0; i<controls.length; i++){ // Fills in the control surface boxes
		var n  = controls[i].name;
		var s  = controls[i].symbol;
		var m  = controls[i].mes;

		var input = "input"+n;
		var control = "control"+n;
		var error = "error"+n;
		var sensor = "sensor"+n;
		positions[i][0] = '<div id="'+ n +'Box" class="controlBox"><span class="controlTitle"><i><b>'+ n.toUpperCase() +'</b></i></span><br><span class="controlContainer">'+
						  '<span id="'+ input +'line">Input: <span id="'+ input +'"></span>'+ s +'</span><br>'+
					   	  '<span id="'+ control +'line">Control Surface: <span id="'+ control +'"></span>'+ s +'</span><br>'+
					      '<span id="'+ error +'line">Error/Difference: <span id="'+ error +'"></span>'+ s +'</span><br>'+
					      '<span id="'+ sensor +'line">Sensor '+ m +': <span id="'+ sensor +'"></span>'+ s +'</span><br>'+
						  '</span></div>';
		// Setup Data Array
		data[input] = 0;
		data[control] = 0;
		data[error] = 0;
		data[sensor] = 37;
		// Push values to linking array
		linkVars.push(input);
		linkVars.push(control);
		linkVars.push(error);
		linkVars.push(sensor);
	}
	positions[3][2] = '<div id="LogBox" class="controlBox"><span id="logTitle" class="controlTitle"><b><i>CURRENT FLIGHT LOG:</i></b>'+
					  '<span class="subnote"><i>(Newest First)</i></span></span><br>'+
					  '<span class="logText"></span>'+
					  '</div>';

	///// TABLE POSITION SETUP /////
	var table = document.getElementById("displayGrid");
	var tableBody = document.createElement("tbody");
	table.appendChild(tableBody);

	for(var x=0;x<positions.length;x++){
		var row = document.createElement("tr");
		tableBody.appendChild(row);
		for(var y=0;y<positions[x].length;y++){
			var cell = document.createElement("td");
			row.appendChild(cell);
			$(cell).html(positions[x][y]);
		}
	}

	///// STYLES SETUP /////
	//$(".controlBox").css({"background":"rgba(130,130,130,0.3)","width":boxWidth+"vw","height":boxHeight+"vw"});
	//$(".controlTitle").css({"color":"#03a", "font-size":headingSize+"vw"});
	//$(".controlContainer").css({"font-size":(headingSize/2)+"vw","line-height":"110%"});
	//$(".subnote").css({"color":"#446","font-size":"60%"});

	//$("#displayGrid").css({"position":"relative","width":(boxWidth*4)+"vw","height":(boxHeight*4)+"vw"});
	//$("td").css({"width":boxWidth+"vw"});
	//$("tr").css({"height":boxHeight+"vw"});

	//$("#LogBox").css({"width":(boxWidth*2)+"vw","align":"center"});
	$("#LogBox").parent().attr('colspan',2); // Makes LogBox 2 cells wide
	//$("#logTitle").css({"color":"#52a","font-size":(headingSize*0.7)+"vw"});
	//$("#topHeading").css({"font-size":(headingSize*1.3)+"vw"});
}

var data = {};
var linkVars = [];

function updateDisplay(){
	for(var i=0; i<linkVars.length; i++){
		var vi = linkVars[i];
		document.getElementById(vi).innerHTML = data[vi];
	}
}

var flashingErrors = {};
var flashLength = 100;

function flashError(id,toggle){
	if(toggle == true){ // Turn on error-flashing
		//console.log(flashingErrors.id);
		if(flashingErrors[id] == undefined){ // If this id does not already have an error-flashng loop
			flashingErrors[id] = setInterval(function(){errFlashLoop();},flashLength);
			$("#"+id).css("color","#d00");
		}
	}else{ // Turn off error-flashing
		if(flashingErrors[id]){ // If there is an error-flashing loop to remove
			clearInterval(flashingErrors[id]);
			delete flashingErrors[id];
			$("#"+id).css("color","#000");
		}else{
			console.log("There was no error-flashing loop to remove from id: "+ id);
		}
	}
	var errFlashLoop = function(){
		var d = new Date();
		var m = d.getMilliseconds();
		var n = Math.round(d.getMilliseconds()/flashLength);

		$("#"+id).css("color","#d00"); // Set color to red (if it wasn't already, to end previous flash)
		if(n == 1 || n == 6){ // Flash Twice per second
			$("#"+id).css("color","#dd0"); // Flash Yellow
		}
	}
}

</script>
</head>
<body onload="setupDisplay(); setInterval(updateDisplay,50)">
<span id="topHeading"><u><b>Aidan's Flight Tracker Following: <span style="color:#00d">BLUE-FIREBIRD v1</span> <span style="color:#0ad">Flight --001</span></b></u></span>
<br>
<br>
<table id="displayGrid"></table>
</body>
</html>